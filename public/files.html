<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
  <script src="/public/util.js"></script>
  
  <title>Files - localtags</title>
</head>
<body>
  <div id="root" class="container" style="max-width: 900px; min-width: 400px;"></div>
<script>
  const idHash = {}; // id-hash 对应表。

  const Alerts = CreateAlerts();
  
  const FileList = cc('div');

  $('#root').append([
    m(Spacer),
    m(Alerts),
    m(FileList).addClass('mt-3'),
    m(Spacer),
    m(BottomLine),
  ]);

  init()
  
  function init() {

    ajax({method:'GET',url:'/api/all-files',alerts:Alerts},
    (files) => {
      files.forEach(file => {
        idHash[file.ID] = file.Hash;

        const item = FileItem(file);
        $(FileList.id).prepend(m(item));

        // item 里的按钮事件，要在 item 被 append 之后添加。
        const tagsText = $(item.id + ' .Tags');
        const tagsInput = $(item.id + ' .TagsInput');
        const inputGroup = $(item.id + ' .input-group');
        $(item.id + ' .OK').click(() => {
          const tags = tagsInput.val();
          const tagsSet = tagsStringToSet(tags);
          tagsText.show().text(addPrefix(tagsSet, '#'));
          inputGroup.hide();
        });

        tagsText.dblclick(() => {
          inputGroup.show();
          tagsInput.val(tagsText.text()).focus();
          tagsText.hide();
        });
      });

      window.setTimeout(() => { $(Tags.id).focus(); }, 200);
    });
  }
  
  function FileItem(file) {
    let thumbClass;
    if (file.Thumb) {
      thumbClass = 'col-md-2 col-3';
      file.Thumb = getTempThumb(file.ID);
    } else {
      thumbClass = 'col-md-2 col-2';
      file.Thumb = getThumbByFiletype(file.Type);
    }

    const self = cc('div', file.ID);

    self.view = () => m('div').attr({id: self.raw_id}).addClass('FileItem card mb-3').append([
      m('div').addClass('row g-0').append([
        m('div').addClass(thumbClass).append([
          m('img').addClass('card-img ').attr({src: file.Thumb}),
        ]),
        m('div').addClass('col').append([
          m('div').addClass('card-body d-flex flex-column h-100').append([
            m('p').addClass('small card-subtitle text-muted').text(`(size: ${fileSizeToString(file.Size)})`),
            m('p').addClass('card-text mb-0').text(file.Name),
            m('div').addClass('Tags small text-muted mt-auto'),
            m('div').addClass('input-group mt-auto').hide().append([
              m('input').addClass('TagsInput form-control'),
              m('button').text('ok').addClass('OK btn btn-outline-secondary').attr({type:'button'}),
            ]),
          ]),
        ]),
      ]),
    ]);

    return self;
  }
  
</script>
</body>
</html>