<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <link rel="stylesheet" href="/public/bootstrap-5beta2.min.css">
  <link rel="stylesheet" href="/public/bootstrap-icons-141.css">
  <link rel="stylesheet" href="/public/style-light.css">
  
  <script src="/public/jquery.min.js"></script>
  <script src="/public/dayjs.min.js"></script>
  <script src="/public/bootstrap.bundle.min.js"></script>
  <script src="/public/util.js"></script>
  <script src="/public/searchform.js"></script>
  
  <title>Images - localtags</title>
  <style>
    .ImageButtons > * {
      color: lightgray;
    }
    .DeleteBtn {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root" class="container"></div>
  <script>

const Alerts = CreateAlerts();

const [InfoBtn, InfoMsg] = CreateInfoPair('使用说明', m('ul').append([
  m('li').text('本页默认列出最近图片（有数量限制，可在 config.json 文件中修改），使用搜索功能可列出更多图片。'),
  m('li').text('删除方法1：点击删除按钮，等删除按钮变红后，再点击一次删除按钮彻底删除该图片，不可恢复。'),
  m('li').text('删除方法2：按 F12 进入控制台输入命令 "delete_file(id)" 把文件扔进回收站，以后可去回收站找回文件。'),
  m('li').text('如需修改文件名或修改标签，请点击图片的 ID。'),
]));

const Navbar = {
  view: () => m('nav').addClass('navbar navbar-light bg-light').append([
    m('div').addClass('container-fluid').append([
      m('a').attr({title:'main menu',href:'/light/home',type:'button'})
        .addClass('btn btn-outline-dark').append(m('i').addClass('bi bi-house-door')),
      m('span').addClass('navbar-brand').append([
        m('span').addClass('PageTitle').text('Images'), ' ', m(InfoBtn),
      ]),
      m('button').attr({title:'Search',type:'button'}).addClass('AllFilesBtn btn btn-outline-dark').append(
        m('i').addClass('bi bi-search'),
      ).click(() => {
        $('.SearchForm').toggle();
        $(SearchInput.id).focus();
      }),
    ]),
  ]),
};

const ImageList = cc('div');

ImageList.append = (files) => {
  files.forEach(file => {
    const item = CreateImageItem(file);
    $(ImageList.id).append(m(item));
    item.init();
  });  
};

ImageList.clear = () => {
  $(ImageList.id).html('');
};

$('#root').append([
  m(Navbar).addClass('my-2'),
  m(InfoMsg).hide(),
  m(SearchForm).addClass('my-2').hide(),
  m(Loading).addClass('my-5'),
  m(Alerts),
  m(ImageList).addClass('ImageList mt-3 d-flex justify-content-around flex-wrap'),
  m(BottomLine),
]);
  
init()

function init() {
  ajax({method:'GET',url:'/api/all-images',alerts:Alerts},
    (files) => {
      if (!files || files.length == 0) {
        Alerts.insert('info', '数据库中没有未删除的图片。');
        return;
      }
      ImageList.append(files);
    }, null, () => {
      Loading.hide();
      console.log('高级功能：使用命令 "delete_file(id)" 把文件扔进回收站，以后可去回收站找回文件。');
    });
}

function CreateImageItem(file) {
  if (file.Thumb) {
    file.Thumb = getThumbURL(file.ID);
  } else {
    file.Thumb = getThumbByFiletype(file.Type);
  }

  const tagGroup = addPrefix(file.Tags);
  const groupLink = '/light/search?tags=' + encodeURIComponent(tagGroup);

  let self = cc('div', file.ID);

  self.view = () => m('div').attr({id:self.raw_id}).addClass('card m-1')
    .css('width','8rem').append([
      m('a').addClass('LinkImage').attr({href:getPreviewURL(file.ID),target:'_blank'}).append(
          m('img').attr({title:file.Name,src: file.Thumb}).addClass('card-img-top'),
        ),
      m('div').addClass('ImageButtons card-body p-2 small d-flex justify-content-between').append([
        m('a').text(file.ID).addClass('text-decoration-none')
          .attr({title:'more...',href:'/light/search?fileid='+file.ID, target:'_blank'}),
        m('a').attr({title:addPrefix(file.Tags, '#'), href:groupLink}).append(
          m('i').addClass('bi bi-tag ml-1'),
        ),
        m('i').addClass('DeleteBtn bi bi-trash ml-1').attr({title:'delete'}),
        m('i').addClass('DeleteRecycle bi bi-trash-fill').hide(),
        m('a').attr({title:'download',download:file.Name, href:'/light/search?fileid='+file.ID}).append(
          m('i').addClass('bi bi-download ml-1')
        ),
        m('span').text('DELETED').addClass('DELETED badge bg-secondary text-white').hide(),
      ]),
    ]);

    self.afterDeleted = () => {
      $(self.id + ' .card-img-top').css('filter', 'opacity(0.5) grayscale(1)');
      disable(self.id + ' .LinkImage');
      $(self.id+' .ImageButtons a').hide();
      $(self.id+' .ImageButtons i').hide();
      $(self.id+' .DELETED').show();
      $(self.id+' .ImageButtons').removeClass('d-flex justify-content-between')
        .addClass('text-center');
    };

    self.init = () => {
      const del_btn_id = self.id+' .DeleteBtn';

      const body = new FormData();
      body.append('id', file.ID);

      $(del_btn_id).click(() => {
        disable(del_btn_id);
        window.setTimeout(() => {
          enable(del_btn_id);
          $(del_btn_id).addClass('text-danger').off().click(() => {
            ajax({method:'POST',url:'/api/really-delete-file',alerts:Alerts,buttonID:del_btn_id,body:body},
                () => {
                  self.afterDeleted();
                });
          });
        }, 1000);
      });
      
      $(self.id+' .DeleteRecycle').click(() => {
        ajax({method:'POST',url:'/api/delete-file',alerts:Alerts,buttonID:del_btn_id,body:body},
            () => {
              console.log(`文件 [id:${file.ID}] 已扔进回收站，可去回收站找回文件。`);
              self.afterDeleted();
            });
      });
    };
/*
  self.init = () => {
    const tagsElem = $(self.id + ' .ImageTags');
    const widthLimit = tagsElem.width() - 20;

    file.Tags.forEach(tag => {
      const item = m('span').text(tag).addClass('badge bg-light text-dark');
      tagsElem.append(item);
      if (item.width() > widthLimit) {
        item.css('width','7rem').addClass('text-truncate');
      }
    });
  };
*/
  return self;
}

function delete_file(id) {
  const del_recycle_id = '#' + id.toUpperCase() + ' .DeleteRecycle';
  if ($(del_recycle_id).length < 1) {
    console.log(`在本页中找不到 id: ${id}`);
    return;
  }
  $(del_recycle_id).click();
}

/*
function try_delete(id) {
  const body = new FormData();
  body.append('id', id);

  ajax({method:'POST',url:'/api/delete-file',body:body},
    () => {
      console.log(`文件 [id:${id}] 已扔进回收站，可去回收站找回文件。`);
    });
}
*/
    </script>
  </body>
</html>
