<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <link rel="stylesheet" href="/public/bootstrap-5beta2.min.css">
  <link rel="stylesheet" href="/public/bootstrap-icons-141.css">
  <link rel="stylesheet" href="/public/style-light.css">
  
  <script src="/public/jquery.min.js"></script>
  <script src="/public/dayjs.min.js"></script>
  <script src="/public/bootstrap.bundle.min.js"></script>
  <script src="/public/util.js"></script>
  <script src="/public/filelist.js"></script>
  
  <title>Infomation - localtags</title>
</head>
<body>
  <div id="root" class="container" style="max-width: 775px; min-width: 400px;"></div>
  <script>

const Alerts = CreateAlerts();

const Navbar = {
  view: () => m('nav').addClass('navbar navbar-light bg-light').append([
    m('div').addClass('container-fluid').append([
      m('a').attr({title:'back to home',href:'/light/home',type:'button'})
        .addClass('btn btn-outline-dark').append(m('i').addClass('bi bi-arrow-left')),
      m('span').addClass('PageTitle navbar-brand').append([
        'Infomation',        
      ]),
      m('a').attr({title:'backup',type:'button',href:'/light/backup'})
        .addClass('btn btn-outline-dark').append(m('i').addClass('bi bi-arrow-right')),
    ]),
  ]),
};

const BucketLocation = cc('span');
const LastChecked = cc('span');
const LastBackup = cc('span');
const AllFilesCount = cc('span');
const DamagedFilesCount = cc('span');
const ForceCheckBtn = cc('button');

const InfoArea = cc('div', null, [
  m('p').append(['仓库地址: ', m(BucketLocation)]),
  m('p').append([
    m('span').append(['上次校验时间: ', m(LastChecked), ' ']),
    m(ForceCheckBtn).text('force check').attr({type:'button'})
        .addClass('btn btn-sm btn-outline-secondary'),
  ]),
  m('p').append([
    m('span').append(['上次备份时间: ', m(LastBackup), ' ']),
    m('a').text('backup now').attr({type:'button',href:'/light/backup'})
        .addClass('btn btn-sm btn-outline-secondary'),
  ]),
  m('p').append(['全部文件（个）: ', m(AllFilesCount)]),
  m('p').append(['其中损坏文件（个）: ', m(DamagedFilesCount)]),
]);

$('#root').append([
  m(Navbar).addClass('mt-2 mb-5'),
  m(Loading),
  m(Alerts),
  m(InfoArea).hide(),
  m(BottomLine),
]);

init()

function init() {
  $(ForceCheckBtn.id).click(() => {
    Alerts.insert('info', '强制校验文件完整性......');
    ajax({method:'GET',url:'/api/force-check-files',alerts:Alerts,buttonID:ForceCheckBtn.id},
        () => {
          Alerts.insert('info', '校验完成时会自动刷新页面，请耐心等待。');
          window.setTimeout(() => {window.location.reload()}, 5000);
        });
  });

  ajax({method:'GET',url:'/api/get-db-info',alerts:Alerts},
      (info) => {
        $(InfoArea.id).show();
        $(BucketLocation.id).text(info.BucketLocation);
        const lastChecked = info.LastChecked ? 
            dayjs.unix(info.LastChecked).format('MMMM D, YYYY') : 'not yet';
        const lastBackup = info.LastBackup ? 
            dayjs.unix(info.LastBackup).format('MMMM D, YYYY') : 'not yet';
        $(LastChecked.id).text(lastChecked);
        $(LastBackup.id).text(lastBackup);
        $(AllFilesCount.id).text(info.AllFilesCount);
        $(DamagedFilesCount.id).text(info.DamagedFilesCount);
        if (info.DamagedFilesCount > 0) {
          $(DamagedFilesCount.id).addClass('text-danger fw-bold');
        }
      }, null, () => { Loading.hide() });
}

</script>
</body>
</html>