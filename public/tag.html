<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <link rel="stylesheet" href="/public/bootstrap-5beta2.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/public/style-light.css">
  
  <script src="/public/jquery.min.js"></script>
  <script src="/public/dayjs.min.js"></script>
  <script src="/public/bootstrap.bundle.min.js"></script>
  <script src="/public/util.js"></script>
  <script src="/public/filelist.js"></script>
  
  <title>Tag - localtags</title>
</head>
<body>
  <div id="root" class="container" style="max-width: 900px; min-width: 400px;"></div>
  <script>

const Alerts = CreateAlerts();

const Navbar = {
  view: () => m('nav').addClass('navbar navbar-light bg-light').append([
    m('div').addClass('container-fluid').append([
      m('a').attr({type:'button'}).addClass('btn btn-outline-dark').append(
        m('i').addClass('bi bi-house-door'),
      ),
      m('span').addClass('navbar-brand').text('Tag'),
      m('div').addClass('btn-group').append([
        m('a').attr({title:'Files',href:'/light/files',type:'button'}).addClass('btn btn-outline-dark').append(
          m('i').addClass('bi bi-card-list')
        ),
        m('a').attr({type:'button'}).addClass('btn btn-outline-dark').append(
          m('i').addClass('bi bi-file-earmark-plus')
        ),
        m('a').attr({title:'Recycle Bin',href:'/light/files?filter=deleted',type:'button'}).addClass('btn btn-outline-dark').append(
          m('i').addClass('bi bi-trash'),
        ),
      ]),
    ]),
  ]),
};

const GroupList = cc('div');
GroupList.prepend = (group) => {
  const item = createTagGroup(group);
  $(GroupList.id).prepend(m(item));
  item.init();
};

$('#root').append([
  m(Navbar).addClass('mt-2 mb-5'),
  m(Alerts),
  m(GroupList),
  m(Spacer),
  m(BottomLine),
]);
  
init()

function init() {
  const name = getUrlParam('name');
  const body = new FormData();
  body.append('name', name);
  
  ajax({method:'POST',url:'/api/get-groups-by-tag',alerts:Alerts,body:body},
  (groups) => {
    if (!groups || groups.length == 0) {
      Alerts.insert('info', 'ç©º');
      return;
    }
    groups.forEach(GroupList.prepend);
  });

}

function createTagGroup(group) {
  const self = cc('div');

  self.view = () => m('div').attr({id: self.raw_id}).addClass('TagGroup card my-3').append([
    m('div').addClass('card-body').append([
      m('div').addClass('Tags'),
    ]),
  ]);

  self.init = () => {
    const tagGroupStr = addPrefix(group);
    const tagsElem = $(self.id + ' .Tags');
    group.forEach(tag => {
      const link = '/light/search?tags=' + encodeURIComponent(tag);
      const item = m('span').text(tag).addClass('badge bg-primary').click(() => {
        window.open(link, 'localtags-search');
      });
      tagsElem.append(item);
    });

    const groupLink = '/light/search?tags=' + encodeURIComponent(tagGroupStr);
    const groupItem = m('span').text('group').attr({title:'search tag group'}).addClass('badge bg-info')
      .click(() => {
        window.open(groupLink, 'localtags-search');
      });
    tagsElem.append(groupItem);
  };

  return self;
}

  </script>
</body>
</html>