# localtags 关于一些细节的说明

本文对本软件的一些细节进行详细说明，不是必读的，用户不需要阅读本文也可正常使用本软件。可以在遇到疑惑时才阅读本文。

## 文件体积上限

单个文件上限默认 512MB (可在 config.json 中设置), 大文件请用压缩软件分卷后上传。

限制文件体积的原因有三个：

1. 我懒；
2. 我不喜欢大体积文件；
3. 在处理文件时（检查文件完整性、生成缩略图等）需要把整个文件读入内存，因此要避免爆内存。


## 关于图片等的预览

- 本软件利用浏览器来做 GUI 界面，为了减少代码量，利用浏览器的默认行为来预览文件。
- 在 "最近文件"(Files) 和 "最近图片"(Images) 页面中，点击支持预览的文件的缩略图（图标）即可预览。
- 我测试的结果是, Firefox 和 Chrome 在打开纯文本、图片、mp3, mp4, pdf 时默认预览（而不是下载），因此本软件暂时只支持预览这些文件。
- 如果你发现浏览器还能预览其他格式的文件，欢迎到 GitHub 给我提 issue.

### 预览与下载的区别

- **下载**必然会有一个复制文件的过程，复制主仓库中的文件到另一个文件夹，在硬盘中产生多一个文件。
- **预览**是让浏览器直接读取主仓库中的文件，不会在硬盘中复制文件，不会产生新文件。


## 本地 markdown 图库

- 在本软件的文件列表 (Files) 界面中点击后缀名为 `.md` 的文件的小图，可预览 markdown 的渲染效果。
- 如果点击文件列表中的图片文件的小图，浏览器会打开一个新标签页显示大图，此时，在地址栏可以看见类似这样的网址 `http://localhost:53549/mainbucket/F1K51`。
- 在 markdown 文件中写 `![图片名称](http://localhost:53549/mainbucket/F1K51)` 即可完成贴图。

按上述方法贴图后，不仅可在本软件中预览 markdown 时看到图片，而且，即使不使用本软件来预览，只要在运行了本软件的电脑中，用任何 markdown 编辑器 (比如 Typora, VS Code 等等) 进行预览，也都可以看到图片。因此，本软件可以当作是一个**本地 markdown 图库**。

### 注意事项

- 本软件的默认网址是 `http://127.0.0.1:53549`, 访问时，通常可以把 127.0.0.1 改为 localhost.
- 网址中的 `53549` 是端口，可在 config.json 文件中设置，但要注意，如果以后更改端口, markdown 文件中的贴图地址不会自动改变，因此更改端口会影响以前的贴图。
- 另外，还可以用这种格式贴图 `![图片名称](/mainbucket/F1K51)`, 这样的好处是，改端口也不会影响以前的贴图，贴图总是有效！但只在本软件中有效，这种贴图方法，用其他编辑器打开 markdown 文件时，就不能看到图片了。
- 建议采用 `![图片名称](http://localhost:53549/mainbucket/F1K51)` 的格式来贴图，因为默认端口 53549 是很罕见的，绝大多数情况下都不会遇到端口冲突，因此不用太担心这个问题。

## 关于同名文件

- 在本软件中，允许文件同名。
- 如果有同名文件，在文件名旁会出现一个数字，表示同名文件数，点击该数字可列出同名文件，按入库顺序排列。
- 修改文件名，以及修改标签时，同名文件的文件名或标签会统一变化。
- 如果需要对其中一个文件单独改名，只能下载该文件，然后在本软件中删除该文件，然后重新上传。（本来应该在改名时提供一个选择框，让用户选择全部文件统一改名还是单个文件单独改名，但考虑到单独改名属于低频操作，因此为了减少代码，采用了目前的方案）。


## 关于备份

- 本软件采用单向备份方式，永远以 *主仓库* 为准，如果在主仓库删除了文件，备份时，也会删除 *备份仓库* 中的对应文件。用户无法直接操作备份仓库。
- 简而言之：在本软件中，备份的最终结果等同于 “清空备份仓库，然后把主仓库的全部文件复制到备份仓库中”（但是当然，实现细节不是这么简单粗暴）。

## 关于文件的损坏与修复

- **文件损坏**：是指文件的内容发生了意料之外的改变，通常是因硬盘故障引起的。（因此，当出现损坏文件时，请留意硬盘的健康程度）
- 当发现文件损坏时，会禁止备份，并出现 "Repair" 按钮，点击该按钮可尝试自动修复文件。
- **自动修复文件**：点击 "Repair" 按钮后，对于备份仓库中的损坏文件，会尝试从主仓库获取同一个 ID 的文件；而对于主仓库中的损坏文件，则尝试从备份仓库获取同一个 ID 的文件；如果同一个 ID 的文件在主仓库和备份仓库里都损坏了，则无法自动修复，需要手动修复。
- **手动修复**的步骤，对于主仓库：1.下载受损文件 2.删除受损文件 3.重新上传文件。而对于备份仓库，则只能一键删除全部受损文件。

### 把备份仓库转换为主仓库

万一，主仓库所在的硬盘突然整个坏掉，或者丢失、被盗，这种情况下需要把备份仓库整个转换为主仓库。暂时我还没有做自动转换工具，但手动转换也不麻烦。

假设备份文件夹是 `D:/localtags/backup`, 手动转换的步骤如下：

1. 按正常方式安装 localtags (详见 README.md)
2. 运行 localtags, 然后关闭 localtags, 这样做是为了自动生成 config.json 文件
3. 把 `D:/localtags/backup/` 整个文件夹复制到另一个硬盘中，假设复制后我们得到文件夹 `C:/localtags/backup/`, 然后改名为 `C:/localtags/data/`
4. 打开 `C:/localtags/data/`, 把里面的 `backup_bucket` 文件夹改名为 `mainbucket`
5. 打开上面第 2 步生成的 config.json 文件，把  "DataFolder" 后的内容修改为 `"D:\\localfiles\\data"`

完成。

这样，我们就可以正常启动 localfiles, 可正常使用，但图片的缩略图没有了。后续我会更新程序，提供恢复缩略图的功能。（因为整个硬盘坏掉/丢失的情况极少发生，因此也不用太担心）。
